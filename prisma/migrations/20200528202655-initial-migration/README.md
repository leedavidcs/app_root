# Migration `20200528202655-initial-migration`

This migration has been generated by leedavidcs at 5/28/2020, 8:26:55 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."User" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"email" text  NOT NULL ,"emailVerified" boolean  NOT NULL DEFAULT false,"id" text  NOT NULL ,"password" text  NOT NULL ,"timezone" text  NOT NULL DEFAULT 'America/Los_Angeles',"updatedAt" timestamp(3)  NOT NULL ,"username" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."StockPortfolio" (
"buyingPower" Decimal(65,30)  NOT NULL DEFAULT 0,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"headers" text []  ,"id" text  NOT NULL ,"name" text  NOT NULL ,"tickers" text []  ,"updatedAt" timestamp(3)  NOT NULL ,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Position" (
"avgEntryPrice" Decimal(65,30)  NOT NULL ,"costBasis" Decimal(65,30)  NOT NULL ,"id" text  NOT NULL ,"quantity" integer  NOT NULL ,"stockPortfolioId" text  NOT NULL ,"ticker" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Order" (
"avgFilledPrice" Decimal(65,30)   ,"cancelledAt" timestamp(3)   ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"failedAt" timestamp(3)   ,"filledAt" timestamp(3)   ,"filledQuantity" integer   ,"id" text  NOT NULL ,"limitPrice" Decimal(65,30)   ,"quantity" integer  NOT NULL ,"side" "OrderSide" NOT NULL ,"status" "OrderStatus" NOT NULL DEFAULT 'Open',"stockPortfolioId" text  NOT NULL ,"stopPrice" Decimal(65,30)   ,"ticker" text  NOT NULL ,"timeInForce" "TimeInForce" NOT NULL DEFAULT 'Day',"type" "OrderType" NOT NULL DEFAULT 'Market',
    PRIMARY KEY ("id"))

CREATE TABLE "public"."StockPortfolioSettings" (
"enableSnapshots" boolean  NOT NULL DEFAULT false,"stockPortfolioId" text  NOT NULL ,
    PRIMARY KEY ("stockPortfolioId"))

CREATE TABLE "public"."Balance" (
"credits" integer  NOT NULL DEFAULT 0,"userId" text  NOT NULL ,
    PRIMARY KEY ("userId"))

CREATE TABLE "public"."Transaction" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"creditsBefore" integer  NOT NULL ,"creditsTransacted" integer  NOT NULL ,"id" text  NOT NULL ,"paymentIntentId" text   ,"status" "TransactionStatus" NOT NULL DEFAULT 'PENDING',"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."StripeDetails" (
"customerId" text  NOT NULL ,"userId" text  NOT NULL ,
    PRIMARY KEY ("userId"))

CREATE TABLE "public"."Webhook" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"query" text   ,"secret" text   ,"stockPortfolioId" text  NOT NULL ,"timeout" integer  NOT NULL DEFAULT 10000,"type" "WebhookType" NOT NULL ,"url" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Snapshot" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"data" text []  ,"headers" text []  ,"id" text  NOT NULL ,"stockPortfolioId" text  NOT NULL ,"tickers" text []  ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."LatestSnapshot" (
"snapshotId" text  NOT NULL ,"stockPortfolioId" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("stockPortfolioId"))

CREATE TABLE "public"."ScheduledEvent" (
"days" "Day"[]  ,"hour" integer  NOT NULL DEFAULT 0,"id" text  NOT NULL ,"interval" integer   ,"minute" integer  NOT NULL DEFAULT 0,"next" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"recurrence" "Recurrence"  ,"userId" text   ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."StockPortfolioEvent" (
"scheduledEventId" text  NOT NULL ,"stockPortfolioId" text  NOT NULL ,"type" "StockPortfolioEventType" NOT NULL ,
    PRIMARY KEY ("scheduledEventId"))

CREATE TABLE "public"."OrderEvent" (
"scheduledEventId" text  NOT NULL ,"type" "OrderEventType" NOT NULL ,
    PRIMARY KEY ("scheduledEventId"))

CREATE UNIQUE INDEX "User.email" ON "public"."User"("email")

CREATE UNIQUE INDEX "User.username" ON "public"."User"("username")

CREATE UNIQUE INDEX "StockPortfolio.userId_name" ON "public"."StockPortfolio"("userId","name")

CREATE UNIQUE INDEX "Position.stockPortfolioId_ticker" ON "public"."Position"("stockPortfolioId","ticker")

CREATE UNIQUE INDEX "StockPortfolioSettings_stockPortfolioId" ON "public"."StockPortfolioSettings"("stockPortfolioId")

CREATE UNIQUE INDEX "Balance_userId" ON "public"."Balance"("userId")

CREATE UNIQUE INDEX "Transaction.paymentIntentId" ON "public"."Transaction"("paymentIntentId")

CREATE UNIQUE INDEX "StripeDetails.customerId" ON "public"."StripeDetails"("customerId")

CREATE UNIQUE INDEX "StripeDetails_userId" ON "public"."StripeDetails"("userId")

CREATE UNIQUE INDEX "LatestSnapshot.snapshotId" ON "public"."LatestSnapshot"("snapshotId")

CREATE UNIQUE INDEX "LatestSnapshot_stockPortfolioId" ON "public"."LatestSnapshot"("stockPortfolioId")

CREATE UNIQUE INDEX "StockPortfolioEvent.stockPortfolioId_type" ON "public"."StockPortfolioEvent"("stockPortfolioId","type")

CREATE UNIQUE INDEX "OrderEvent.type" ON "public"."OrderEvent"("type")

ALTER TABLE "public"."StockPortfolio" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Position" ADD FOREIGN KEY ("stockPortfolioId")REFERENCES "public"."StockPortfolio"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Order" ADD FOREIGN KEY ("stockPortfolioId")REFERENCES "public"."StockPortfolio"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."StockPortfolioSettings" ADD FOREIGN KEY ("stockPortfolioId")REFERENCES "public"."StockPortfolio"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Balance" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Transaction" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."StripeDetails" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Webhook" ADD FOREIGN KEY ("stockPortfolioId")REFERENCES "public"."StockPortfolio"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Snapshot" ADD FOREIGN KEY ("stockPortfolioId")REFERENCES "public"."StockPortfolio"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."LatestSnapshot" ADD FOREIGN KEY ("snapshotId")REFERENCES "public"."Snapshot"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."LatestSnapshot" ADD FOREIGN KEY ("stockPortfolioId")REFERENCES "public"."StockPortfolio"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."ScheduledEvent" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."StockPortfolioEvent" ADD FOREIGN KEY ("scheduledEventId")REFERENCES "public"."ScheduledEvent"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."StockPortfolioEvent" ADD FOREIGN KEY ("stockPortfolioId")REFERENCES "public"."StockPortfolio"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."OrderEvent" ADD FOREIGN KEY ("scheduledEventId")REFERENCES "public"."ScheduledEvent"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200528202655-initial-migration
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,241 @@
+// This is your Prisma schema file,
+// learn more about it in the docs: https://pris.ly/d/prisma-schema
+
+datasource db {
+  provider = "postgresql"
+  url      = env("DATABASE_URL")
+}
+
+generator client {
+  provider = "prisma-client-js"
+}
+
+model User {
+  id              String   @id @default(cuid())
+  email           String   @unique
+  emailVerified   Boolean  @default(false)
+  password        String
+  username        String   @unique
+  timezone        String   @default("America/Los_Angeles")
+  balance         Balance
+  stripeDetails   StripeDetails?
+  stockPortfolios StockPortfolio[]
+  createdAt       DateTime @default(now())
+  updatedAt       DateTime @updatedAt
+}
+
+// Commented out until embedded types are available
+// model StockPortfolioHeader {
+//   id        String @id @default(cuid())
+//   name      String
+//   dataKey   String
+//   width     Int @default(100)
+//   frozen    Boolean @default(false)
+//   resizable Boolean @default(true)
+// }
+
+model StockPortfolio {
+  id             String                 @id @default(cuid())
+  user           User                   @relation(fields: [userId], references: [id])
+  userId         String
+  name           String
+  // This should be Json[], but as of prisma@2.0.0-beta.6, Json[] does not work correctly
+  headers        String[]
+  tickers        String[]
+  settings       StockPortfolioSettings
+  snapshots      Snapshot[]
+  orders         Order[]
+  latestSnapshot LatestSnapshot?
+  buyingPower    Float                  @default(0)
+  createdAt      DateTime               @default(now())
+  updatedAt      DateTime               @updatedAt
+
+  @@unique([userId, name])
+}
+
+model Position {
+  id               String         @id @default(cuid())
+  stockPortfolio   StockPortfolio @relation(fields: [stockPortfolioId], references: [id])
+  stockPortfolioId String
+  ticker           String
+  quantity         Int
+  avgEntryPrice    Float
+  costBasis        Float
+
+  @@unique([stockPortfolioId, ticker])
+}
+
+enum OrderSide {
+  Buy
+  Sell
+}
+
+enum OrderType {
+  Market
+  Limit
+  Stop
+  StopLimit
+}
+
+enum OrderStatus {
+  Open
+  Closed
+}
+
+enum TimeInForce {
+  Day
+  GTC
+  OPG
+  CLS
+  IOC
+  FOK
+}
+
+model Order {
+  id               String         @id @default(cuid())
+  stockPortfolio   StockPortfolio @relation(fields: [stockPortfolioId], references: [id])
+  stockPortfolioId String
+  ticker           String
+  quantity         Int
+  filledQuantity   Int?
+  type             OrderType      @default(Market)
+  side             OrderSide
+  status           OrderStatus    @default(Open)
+  limitPrice       Float?
+  stopPrice        Float?
+  avgFilledPrice   Float?
+  timeInForce      TimeInForce    @default(Day)
+  createdAt        DateTime       @default(now())
+  filledAt         DateTime?
+  cancelledAt      DateTime?
+  failedAt         DateTime?
+}
+
+model StockPortfolioSettings {
+  stockPortfolio   StockPortfolio @relation(fields: [stockPortfolioId], references: [id])
+  stockPortfolioId String         @id
+  enableSnapshots  Boolean        @default(false)
+}
+
+model Balance {
+  user    User   @relation(fields: [userId], references: [id])
+  userId  String @id
+  credits Int    @default(0)
+}
+
+enum TransactionStatus {
+  FAILED
+  PENDING
+  SUCCEEDED
+}
+
+model Transaction {
+  id                String            @id @default(cuid())
+  user              User              @relation(fields: [userId], references: [id])
+  userId            String
+  creditsBefore     Int
+  creditsTransacted Int
+  createdAt         DateTime          @default(now())
+  paymentIntentId   String?           @unique
+  status            TransactionStatus @default(PENDING)
+}
+
+model StripeDetails {
+  user       User   @relation(fields: [userId], references: [id])
+  userId     String @id
+  customerId String @unique
+}
+
+enum WebhookType {
+  StockDataRetrieved
+}
+
+model Webhook {
+  id               String         @id @default(cuid())
+  stockPortfolio   StockPortfolio @relation(fields: [stockPortfolioId], references: [id])
+  stockPortfolioId String
+  query            String?
+  secret           String?
+  type             WebhookType
+  url              String
+  timeout          Int            @default(10000)
+  createdAt        DateTime       @default(now())
+}
+
+model Snapshot {
+  id               String         @id @default(cuid())
+  tickers          String[]
+  // This should be Json[], but as of prisma@2.0.0-beta.6, Json[] does not work correctly
+  headers          String[]
+  stockPortfolio   StockPortfolio @relation(fields: [stockPortfolioId], references: [id])
+  stockPortfolioId String
+  // This should be Json[], but as of prisma@2.0.0-beta.6, Json[] does not work correctly
+  data             String[]
+  createdAt        DateTime       @default(now())
+}
+
+// Each stock-portfolio tracks its latest data-fetch
+model LatestSnapshot {
+  snapshot         Snapshot       @relation(fields: [snapshotId], references: [id])
+  snapshotId       String         @unique
+  stockPortfolio   StockPortfolio @relation(fields: [stockPortfolioId], references: [id])
+  stockPortfolioId String         @id
+  updatedAt        DateTime       @updatedAt
+}
+
+enum Day {
+  Mon
+  Tues
+  Wed
+  Thurs
+  Fri
+  Sat
+  Sun
+}
+
+enum Recurrence {
+  Once
+  Weekly
+  Daily
+}
+
+model ScheduledEvent {
+  id         String      @id @default(cuid())
+  // The user that created this scheduled-event (uses their timezone data). If no user, then the
+  // scheduled-event is a system-event, and should be executed in timezone = America/Los_Angeles
+  user       User?       @relation(fields: [userId], references: [id])
+  userId     String?
+  recurrence Recurrence?
+  days       Day[]
+  hour       Int         @default(0)
+  minute     Int         @default(0)
+  // Interval in minutes for min time till next execution
+  interval   Int?
+  next       DateTime    @default(now())
+}
+
+enum StockPortfolioEventType {
+  DataRetrieved
+}
+
+model StockPortfolioEvent {
+  scheduledEvent   ScheduledEvent          @relation(fields: [scheduledEventId], references: [id])
+  scheduledEventId String                  @id
+  type             StockPortfolioEventType
+  stockPortfolio   StockPortfolio          @relation(fields: [stockPortfolioId], references: [id])
+  stockPortfolioId String
+
+  @@unique([stockPortfolioId, type])
+}
+
+enum OrderEventType {
+  CloseExpiredOrders
+  DeleteInvalidOrders
+  ExecuteOpenOrders
+}
+
+model OrderEvent {
+  scheduledEvent   ScheduledEvent @relation(fields: [scheduledEventId], references: [id])
+  scheduledEventId String         @id
+  type             OrderEventType @unique
+}
```



# Migration `20200518040841-new-order-and-position-models`

This migration has been generated by leedavidcs at 5/18/2020, 4:08:41 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "OrderSide" AS ENUM ('Buy', 'Sell');

CREATE TYPE "OrderType" AS ENUM ('Market', 'Limit', 'Stop', 'StopLimit');

CREATE TYPE "OrderStatus" AS ENUM ('Open', 'Closed');

CREATE TABLE "public"."Position" (
"avgEntryPrice" Decimal(65,30)  NOT NULL ,"costBasis" Decimal(65,30)  NOT NULL ,"id" text  NOT NULL ,"quantity" integer  NOT NULL ,"stockPortfolioId" text  NOT NULL ,"ticker" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Order" (
"avgFilledPrice" Decimal(65,30)   ,"cancelledAt" timestamp(3)   ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"failedAt" timestamp(3)   ,"filledAt" timestamp(3)   ,"id" text  NOT NULL ,"limitPrice" Decimal(65,30)   ,"quantity" integer  NOT NULL ,"side" "OrderSide" NOT NULL ,"status" "OrderStatus" NOT NULL DEFAULT 'Open',"stockPortfolioId" text  NOT NULL ,"stopPrice" Decimal(65,30)   ,"ticker" text  NOT NULL ,"type" "OrderType" NOT NULL ,
    PRIMARY KEY ("id"))

ALTER TABLE "public"."StockPortfolio" ADD COLUMN "balance" Decimal(65,30)  NOT NULL DEFAULT 0;

ALTER TABLE "public"."Transaction" ALTER COLUMN "status" SET DEFAULT 'PENDING';

CREATE UNIQUE INDEX "Position.stockPortfolioId_ticker" ON "public"."Position"("stockPortfolioId","ticker")

ALTER TABLE "public"."Position" ADD FOREIGN KEY ("stockPortfolioId")REFERENCES "public"."StockPortfolio"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Order" ADD FOREIGN KEY ("stockPortfolioId")REFERENCES "public"."StockPortfolio"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200517190619-reduce-default-webhook-timeout..20200518040841-new-order-and-position-models
--- datamodel.dml
+++ datamodel.dml
@@ -2,9 +2,9 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("DATABASE_URL")
 }
 generator client {
   provider = "prisma-client-js"
@@ -31,21 +31,69 @@
 //   resizable Boolean @default(true)
 // }
 model StockPortfolio {
-  id        String   @id @default(cuid())
-  user      User     @relation(fields: [userId], references: [id])
+  id        String                 @id @default(cuid())
+  user      User                   @relation(fields: [userId], references: [id])
   userId    String
   name      String
   headers   String[]
   tickers   String[]
   settings  StockPortfolioSettings
-  createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt
+  balance   Float                  @default(0)
+  createdAt DateTime               @default(now())
+  updatedAt DateTime               @updatedAt
   @@unique([userId, name])
 }
+model Position {
+  id               String         @id @default(cuid())
+  stockPortfolio   StockPortfolio @relation(fields: [stockPortfolioId], references: [id])
+  stockPortfolioId String
+  ticker           String
+  quantity         Int
+  avgEntryPrice    Float
+  costBasis        Float
+
+  @@unique([stockPortfolioId, ticker])
+}
+
+enum OrderSide {
+  Buy
+  Sell
+}
+
+enum OrderType {
+  Market
+  Limit
+  Stop
+  StopLimit
+}
+
+enum OrderStatus {
+  Open
+  Closed
+}
+
+model Order {
+  id               String         @id @default(cuid())
+  stockPortfolio   StockPortfolio @relation(fields: [stockPortfolioId], references: [id])
+  stockPortfolioId String
+  ticker           String
+  quantity         Int
+  type             OrderType
+  side             OrderSide
+  status           OrderStatus    @default(Open)
+  limitPrice       Float?
+  stopPrice        Float?
+  avgFilledPrice   Float?
+  createdAt        DateTime       @default(now())
+  filledAt         DateTime?
+  cancelledAt      DateTime?
+  failedAt         DateTime?
+}
+
 model StockPortfolioSettings {
   stockPortfolio   StockPortfolio @relation(fields: [stockPortfolioId], references: [id])
   stockPortfolioId String         @id
   enableSnapshots  Boolean        @default(false)
```


